<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <script src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.8.0.js">
  </script>
  <script src="https://momentjs.com/downloads/moment-with-locales.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link href="style.css" rel="stylesheet" type="text/css">
  <title>Directory1206</title>
</head>

<body>
  <div>
    <table>
      <tr>
        <td colspan="5">
          <h1>Directory</h1>
        </td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td colspan="1"><input type="button" value="New Contact" id="btnNewContact"></td>
       
      </tr>

    </table>
    <hr>
  </div>

  <div>
    <table border="1">

      <thead>
        <tr>
          <th>No.</th>
          <th>Name</th>
          <th>Phone</th>
          <th>Sex</th>
          <th>Category</th>
          <th>Memo</th>
          <th>Actions</th>
          <th>Updated Time</th>

        </tr>

      </thead>
      <tbody id="bodyContent">
        <tr id="noContactTr">
          <td colspan="8">No contact!</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div id="tmplNewContract" style="display: none;">
    <table>
      <tr id="addNewContactHtml">
        <td>
          <span id="num"></span>
        </td>
        <td>
          <span class="name" style="display: none;"></span>
          <input class="inputName" type="text" placeholder="name">
        </td>
        <td>
          <span class="phone" style="display: none;"></span>
          <input class="inputPhone" type="text" placeholder="phone number">
        </td>
        <td>
          <span class="spanSex" ></span>
          <span class="spanFemale" style="display: none;" ><i class="fa fa-female" ></i></span>
          <span class="spanMale" style="display: none;"><i class="fa fa-male" ></i></span>
          <div id="inputSex">
            <input  name = "sex" type="radio" value="Male" id="Male">Male
            <input  name = "sex" type="radio" value="Female" id="Female">Female

          </div>
          

        </td>
        <td>
          <span class="category" style="display: none;"></span>
          <select name="category" class="inputCategory">
            <option selected="selected" value="">-select-</option>
            <option value="Family">Family</option>
            <option value="Friend">Friend</option>
            <option value="Co-worker">Co-worker</option>
            <option value="Teacher">Teacher</option>
            <option value="Acquaitance">Acquaitance</option>
            <option value="Classmate">Classmate</option>
          </select>
        </td>
        <td>
          <span class="memo" style="display: none;"></span>
          <textarea class="inputMemo" cols="30" rows="3" placeholder="輸入你想要寫的內容..."></textarea>
        </td>
        <td>
          <span class="btnsForDisplay" style="display: none;">
            <input type="button" value="Edit" id="edit">
            <input type="button" value="Remove" id="remove">
          </span>

          <span class="btnsForEdit">
            <input type="button" value="Save" id="btnSaveContact">
            <input type="button" value="Cancel" id="btnCancelEditing">
          </span>
        </td>
        <td><span class="updatedTime"></span></td>
      </tr>
    </table>
  </div>
  <div id="templNoContact" style="display: none;">
    <table>
      <tbody>
        <tr id="noContactTr" class="noContactTr">
          <td colspan="8">No contact !</td>
        </tr>
      </tbody>

    </table>
  </div>

  <script>
    var name = "";
    var phone = "";
    var sex = "";
    var category = "";
    var memo = "";
    var contactList = [];
    var isEdit = false;
    var userName = "";
    var updatedTime = "";

    $(document).ready(function () {

      registerNewContactButtonClickEvent();
      registerCancelEditingButtonClickEvent();
      registerSaveContactButtonClickEvent();
      registerRemoveContactClickEvent();
      registerEditContactClickEvent();
      userName = prompt("please input your name", "");
      checkCookie()
      registerHoverEvent();
    });


    function registerHoverEvent() {
      $("div").on("hover", function () {
        $(".newTr").hover(function () { $(this).addClass("enter") }, function () { $(this).removeClass("enter") });
        $(":button").hover(function () { $(this).addClass("enterBtn") }, function () { $(this).removeClass("enterBtn") });
      })

    }

    function dealWithJson() {
      var jsonObject = JSON.stringify(contactList);
      setCookie(userName, jsonObject, 10);

    }

    function setCookie(cname, cvalue, exdays) {
      var date = new Date();
      date.setTime(date.getTime() + (exdays * 24 * 60 * 60 * 1000));
      var expires = "expires=" + date.toGMTString();
      document.cookie = cname + "=" + cvalue + "; " + expires;

    }

    function checkCookie() {

      if (userName != "" && userName != null) {
        // alert("Welcome~ " + userName);
        var contactObjects = getCookie(userName);
        var contactListFromCookie = JSON.parse(contactObjects);
        contactList = contactListFromCookie;
        displayContacts();

      } else {
        prompt("please input your name", "");
        if (userName != "" && userName != null) {
          dealWithJson();
        }
      }
    }

    function getCookie(name) {
        var value = "; " + document.cookie;
        console.log("value = " + value);

        var parts = value.split("; " + name + "=");
        console.log("parts = " + parts);
        if (parts.length == 2) return parts.pop().split(";").shift();

      }

    function registerNewContactButtonClickEvent() {
      $("#btnNewContact").click(function () {
       
        $("#bodyContent").find("#noContactTr").hide();
        var trObj = $("#tmplNewContract tbody tr")[0].outerHTML;
        $("#bodyContent").append(trObj);
        $("#bodyContent").find("tr").addClass("newTr");
        $("#btnNewContact").prop("disabled", true);
        $(".btnsForDisplay :button").prop("disabled",true);
       

  
  
 
      })
    }

    function registerCancelEditingButtonClickEvent() {
      $("div").on("click", "#btnCancelEditing", function () {

        if (isEdit === false) {
          var tr = $(this).closest("tr");
          tr.find("#num");
          tr.remove();
        } else {
          isEdit = false;
        }
        displayContacts();
      });
    }


    function registerRemoveContactClickEvent() {
      $("div").on("click", "#remove", function (event) {
        var answer = confirm("Are you sure you want to delete this contact info?");
        if (answer == true) {
          var tr = $(this).closest("tr");
          var index = tr.find("#num").text();
          contactList[index - 1]
          contactList.splice(index - 1, 1);
          displayContacts();
        } else {
          //do nothing
        }
      });

    }
    //首次save
    function registerSaveContactButtonClickEvent() {

      $("div").on("click", "#btnSaveContact", function () {
        //get value from input

        var tr3 = $(this).closest("tr");
        var itemNumber
        name = tr3.find(".inputName").val();
        phone = tr3.find(".inputPhone").val();
        sex = tr3.find("input[name=sex]:checked").val();
        category = tr3.find(".inputCategory").val();
        memo = tr3.find(".inputMemo").val();
        
        if (checkInputValue(name, phone, category) === false){
          tr3.find(".inputName").attr("id","alertName");
          tr3.find(".inputPhone").attr("id","alertPhone");
          tr3.find(".inputCategory").attr("id","alerCategory");
          return;
        }
        if (isEdit === true) {
          var num = tr3.find("#num").text();
          isEdit = false;
          var contactObject = contactList[num - 1];
          contactObject.name = name;
          contactObject.phone = phone;
          contactObject.sex = sex;
          contactObject.category = category;
          contactObject.memo = memo;
          contactObject.updatedTime = dealWithDate();


        } else {
       
          contactList.push({
            'name' :  name,
            'phone' : phone,
            'sex' : sex,
            'category' : category,
            'memo' : memo,
            'updatedTime':dealWithDate()
          });
          itemNumber = contactList.length;
          
          if (tr3.find("#num").text().length == 0) {
            tr3.find("#num").text(itemNumber);
          }
        }
        //change to display mode
        displayContacts();

      });

    }

    function registerEditContactClickEvent() {

      var name = "";
      var phone = "";
      var sex = "";
      var category = "";
      var memo = "";

      $("div").on('click', '#edit', function (event) {
        isEdit = true;
        var tr = $(this).closest("tr");
        $(tr).find("span").hide();
        $(tr).find(".btnsForDisplay").hide();
        $(tr).find(":text").show();
        $(tr).find("#inputSex").show();
        $(tr).find(".inputCategory").show();
        $(tr).find(".inputMemo").show();
        $(tr).find(".btnsForEdit").show();
        $(tr).find("#num").show();

        name = tr.find(".name").text();
        phone = tr.find(".phone").text();
        sex = tr.find(".spanSex").text();
        category = tr.find(".category").text();
        memo = tr.find(".memo").text();
        //set value to input mode
        $(tr).find(".inputName").val(name);
        $(tr).find(".inputPhone").val(phone);
        $(tr).find(".inputCategory").val(category);
        $(tr).find(".inputMemo").val(memo);
        console.log("edit sex = " + sex);
 
        sex == "Female"?$(tr).find("#Female").prop("checked",true): $(tr).find("#Male").prop("checked",true);
       
        //disable other buttons
        $(".btnsForDisplay :button").prop("disabled",true);
        $("#btnNewContact").prop("disabled", true);
       
      });
    }

  

    function displayContacts() {
      dealWithJson();
      dealWithDate();
      $("#bodyContent").empty();
      if (contactList.length === 0) {
        var noContactTemp = $(".noContactTr")[0].outerHTML;
        $("#bodyContent").append(noContactTemp);

      } else {

        for (i = 0; i < contactList.length; i++) {
          var contactObject = contactList[i];
          var trObj = $("#tmplNewContract tbody tr")[0].outerHTML;
          $("#bodyContent").append(trObj);
          $("#bodyContent").find("tr").addClass("newTr");

          var tr = $("#bodyContent tr")[i];
          $(tr).find("#num").text(i + 1);
          $(tr).find(".name").text(contactObject.name);
          $(tr).find(".phone").text(contactObject.phone);
          $(tr).find(".spanSex").text(contactObject.sex);
          $(tr).find(".category").text(contactObject.category);
          $(tr).find(".memo").text(contactObject.memo);
          $(tr).find(".updatedTime").text(contactObject.updatedTime);
          contactObject.sex == "Female"? $(tr).find(".spanFemale").show(): $(tr).find(".spanMale").show();
        }

        $(".newTr").find(":text").hide();
        $(".newTr").find("#inputSex").hide();
        $(".newTr").find(".name").show();
        $(".newTr").find(".phone").show();
        $(".newTr").find(".category").show();
        $(".newTr").find(".memo").show();
        $(".newTr").find(".updatedTime").show();
        $(".newTr").find(".inputCategory").hide();
        $(".newTr").find(".inputMemo").hide();
        $(".newTr").find(".btnsForDisplay").show();
        $(".newTr").find(".btnsForEdit").hide();
        $(".newTr").find(".spanSex").hide();
        
        //enable other buttons
        $(".btnsForDisplay :button").prop("disabled",false);
        $("#btnNewContact").prop("disabled", false);
        
      }
    }

    function checkInputValue(name, phone, category) {
        if (name === undefined || name.length === 0 || name === null) {
          alert("Please input contact name!");
          return false;
        }

        if (phone === undefined || phone.length === 0 || phone === null) {
          alert("Please input phone number!");
          return false;
        }

        if (category === undefined || category.length === 0 || category === null) {
          alert("Please select the category!");
          return false;
        }
      }


      function dealWithDate(){
          var date = moment().format('lll'); 
          return date;

      }

  </script>
</body>

</html>